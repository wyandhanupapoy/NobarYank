<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wyandhanu & Maha - Private Cinema</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --primary: #f43f5e;
            --accent: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --glass: rgba(15, 23, 42, 0.95);
            --text: #f8fafc;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* HEADER */
        header {
            padding: 12px 20px;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 50;
            position: relative;
        }

        .couple-names { 
            font-size: 1.1rem; 
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .couple-names span { color: var(--primary); }
        .heart-icon { 
            color: var(--primary); 
            margin: 0 8px; 
            animation: heartbeat 1.5s infinite;
            filter: drop-shadow(0 0 8px rgba(244, 63, 94, 0.6));
        }
        @keyframes heartbeat { 
            0%, 100% { transform: scale(1); } 
            50% { transform: scale(1.3); } 
        }

        #statusBadge {
            font-size: 0.75rem;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        #statusBadge.offline { background: #334155; color: #94a3b8; }
        #statusBadge.standby { background: #1e40af; color: #93c5fd; }
        #statusBadge.connecting { background: #f59e0b; color: #fef3c7; }
        #statusBadge.connected { background: var(--success); color: white; }
        #statusBadge.error { background: var(--danger); color: white; }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* MAIN STAGE */
        .main-stage {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            width: 100%;
            overflow: hidden;
        }

        #screenVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }

        #screenVideo.active {
            display: block;
        }

        .placeholder-text {
            position: absolute;
            color: #64748b;
            text-align: center;
            z-index: 1;
            padding: 20px;
            pointer-events: none;
        }

        .placeholder-text i {
            font-size: 4rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* CAMERA FLOATING */
        .cam-container {
            position: absolute;
            bottom: 100px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 20;
            transition: all 0.3s ease;
        }

        .cam-box {
            width: 130px;
            height: 130px;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 16px;
            overflow: hidden;
            border: 3px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 25px rgba(0,0,0,0.6);
            position: relative;
            transition: all 0.3s ease;
        }

        .cam-box:hover {
            transform: scale(1.05);
            border-color: var(--primary);
        }

        .cam-box video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        
        .cam-label {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            font-size: 11px;
            background: rgba(0,0,0,0.8);
            text-align: center;
            padding: 4px;
            font-weight: 600;
            backdrop-filter: blur(5px);
        }

        .cam-box.offline {
            opacity: 0.4;
        }

        .cam-box.offline::after {
            content: 'Offline';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #64748b;
            font-size: 12px;
            font-weight: 600;
        }

        /* CONNECTION PANEL */
        .connection-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass);
            padding: 30px;
            border-radius: 24px;
            border: 2px solid #334155;
            text-align: center;
            z-index: 100;
            width: 90%;
            max-width: 420px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.9);
            transition: all 0.3s ease;
        }
        
        .connection-panel.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translate(-50%, -50%) scale(0.9);
            visibility: hidden;
        }

        .connection-panel h3 {
            margin-top: 0;
            font-size: 1.5rem;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        input {
            width: 100%;
            padding: 14px;
            margin: 12px 0;
            border-radius: 12px;
            border: 2px solid #475569;
            background: #1e293b;
            color: white;
            text-align: center;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .btn-connect {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, var(--primary), #ec4899);
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(244, 63, 94, 0.4);
        }

        .btn-connect:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 63, 94, 0.6);
        }

        .btn-connect:active {
            transform: translateY(0);
        }

        .id-display {
            margin-top: 20px;
            padding: 15px;
            border: 2px dashed #475569;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(0,0,0,0.3);
        }

        .id-display:hover {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
        }

        .id-display .label {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-bottom: 5px;
        }

        #myId {
            color: var(--accent);
            font-weight: 700;
            word-break: break-all;
            font-size: 0.95rem;
        }

        /* CONTROL BAR */
        .control-bar {
            padding: 15px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .btn-control {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: none;
            background: #334155;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .btn-control:hover {
            transform: scale(1.1);
        }

        .btn-control:active {
            transform: scale(0.95);
        }

        .btn-control.active {
            background: var(--success);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.6);
        }
        
        .btn-hangup {
            background: var(--danger) !important;
            width: 60px;
            height: 60px;
            font-size: 1.4rem;
        }

        .btn-hangup:hover {
            background: #dc2626 !important;
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.8) !important;
        }

        .btn-screen {
            background: var(--accent) !important;
        }

        .btn-screen:hover {
            background: #2563eb !important;
        }

        .divider {
            width: 2px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            margin: 0 5px;
        }

        /* TOAST NOTIFICATION */
        .toast {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .couple-names { font-size: 0.95rem; }
            
            .cam-container {
                flex-direction: row;
                bottom: 90px;
                right: 50%;
                transform: translateX(50%);
                width: auto;
                justify-content: center;
            }
            
            .cam-box {
                width: 90px;
                height: 90px;
                border-radius: 50%;
            }
            
            .cam-label { font-size: 9px; }
            
            .connection-panel {
                padding: 25px;
                max-width: 95%;
            }
            
            .btn-control {
                width: 50px;
                height: 50px;
                font-size: 1.1rem;
            }
            
            .btn-hangup {
                width: 55px;
                height: 55px;
            }
        }

        @media (max-height: 500px) and (orientation: landscape) {
            header, .control-bar {
                opacity: 0.3;
                transition: opacity 0.3s;
            }
            
            header:hover, .control-bar:hover {
                opacity: 1;
            }
            
            .cam-container {
                right: 10px;
                bottom: 10px;
                flex-direction: column;
                transform: none;
                opacity: 0.7;
            }
            
            .cam-container:hover {
                opacity: 1;
            }
            
            .cam-box {
                width: 80px;
                height: 80px;
            }
        }

        /* LOADING SPINNER */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<header>
    <div class="couple-names">
        Wyandhanu <i class="fas fa-heart heart-icon"></i> Maha
    </div>
    <div id="statusBadge" class="offline">
        <span class="status-dot"></span>
        <span>Offline</span>
    </div>
</header>

<div class="main-stage">
    <div class="placeholder-text" id="placeholder">
        <i class="fas fa-film"></i><br>
        <div style="font-size: 1.2rem; margin-top: 10px;">Menunggu Koneksi...</div>
        <div style="font-size: 0.85rem; color: #475569; margin-top: 5px;">Hubungkan dengan pasangan untuk memulai</div>
    </div>
    
    <video id="screenVideo" autoplay playsinline></video>

    <div class="cam-container">
        <div class="cam-box offline" id="myCamBox">
            <video id="myCam" autoplay playsinline muted></video>
            <div class="cam-label">Saya</div>
        </div>
        <div class="cam-box offline" id="partnerCamBox">
            <video id="partnerCam" autoplay playsinline></video>
            <div class="cam-label">Pasangan</div>
        </div>
    </div>
</div>

<div id="connectPanel" class="connection-panel">
    <h3>Mulai Nobar üçø</h3>
    <p style="color: #94a3b8; font-size: 0.9rem; margin: 10px 0;">Sambungkan dengan pasangan untuk mulai menonton bersama</p>
    
    <input type="text" id="partnerIdInput" placeholder="Tempel ID Pasangan di sini...">
    
    <button onclick="handleConnectButton()" class="btn-connect">
        <span id="connectBtnText">Hubungkan Sekarang</span>
    </button>
    
    <div class="id-display" onclick="copyMyId()">
        <div class="label">ID Kamu (Klik untuk Salin):</div>
        <div id="myId">Generating...</div>
    </div>
    
    <div style="margin-top: 15px; font-size: 0.75rem; color: #64748b;">
        <i class="fas fa-info-circle"></i> Bagikan ID ini ke pasangan Anda
    </div>
</div>

<div class="control-bar">
    <button id="btnMic" onclick="toggleMic()" class="btn-control" title="Microphone">
        <i class="fas fa-microphone-slash"></i>
    </button>
    
    <button id="btnCam" onclick="toggleCam()" class="btn-control" title="Camera">
        <i class="fas fa-video-slash"></i>
    </button>
    
    <div class="divider"></div>
    
    <button onclick="endCall()" class="btn-control btn-hangup" title="Putuskan Koneksi">
        <i class="fas fa-phone-slash"></i>
    </button>
    
    <div class="divider"></div>
    
    <button id="btnScreen" onclick="startScreenShare()" class="btn-control btn-screen" title="Share Screen">
        <i class="fas fa-desktop"></i>
    </button>
</div>

<div id="toast" class="toast"></div>

<script>
    // ============================================
    // KONFIGURASI & INISIALISASI
    // ============================================
    
    const peerConfig = {
        debug: 2,
        config: {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:global.stun.twilio.com:3478' }
            ]
        }
    };

    let peer = null;
    let myId = null;
    let partnerId = null;
    
    // State Management
    const state = {
        isConnected: false,
        isConnecting: false,
        isCamOn: false,
        isMicOn: false,
        isScreenSharing: false,
        myCamStream: null,
        activeFaceCall: null,
        activeScreenCall: null,
        dataConnection: null
    };

    // UI Elements
    const elements = {
        myIdEl: document.getElementById('myId'),
        connectPanel: document.getElementById('connectPanel'),
        statusBadge: document.getElementById('statusBadge'),
        screenVideo: document.getElementById('screenVideo'),
        myCamVideo: document.getElementById('myCam'),
        partnerCamVideo: document.getElementById('partnerCam'),
        myCamBox: document.getElementById('myCamBox'),
        partnerCamBox: document.getElementById('partnerCamBox'),
        placeholder: document.getElementById('placeholder'),
        partnerIdInput: document.getElementById('partnerIdInput'),
        connectBtnText: document.getElementById('connectBtnText'),
        toast: document.getElementById('toast')
    };

    // ============================================
    // PEER INITIALIZATION
    // ============================================
    
    function initializePeer() {
        peer = new Peer(undefined, peerConfig);
        
        peer.on('open', (id) => {
            myId = id;
            elements.myIdEl.innerText = id;
            updateStatus('standby', 'Standby');
            showToast('‚úÖ Siap! Bagikan ID Anda ke pasangan');
        });

        peer.on('error', (err) => {
            console.error('Peer error:', err);
            if (err.type === 'peer-unavailable') {
                showToast('‚ùå ID pasangan tidak ditemukan');
                updateStatus('error', 'Gagal Koneksi');
                state.isConnecting = false;
                elements.connectBtnText.innerHTML = 'Hubungkan Sekarang';
            } else {
                showToast('‚ùå Error: ' + err.message);
            }
        });

        peer.on('call', handleIncomingCall);
        peer.on('connection', handleIncomingData);
    }

    // ============================================
    // INCOMING CALL HANDLER
    // ============================================
    
    function handleIncomingCall(call) {
        const callType = call.metadata?.type || 'face';
        console.log('Incoming call:', callType);

        if (callType === 'screen') {
            // Handle screen share
            state.activeScreenCall = call;
            call.answer(); // Answer without stream
            
            call.on('stream', (remoteStream) => {
                console.log('Receiving screen stream');
                elements.screenVideo.srcObject = remoteStream;
                elements.screenVideo.classList.add('active');
                elements.placeholder.style.display = 'none';
                showToast('üì∫ Menonton layar pasangan');
            });

            call.on('close', () => {
                console.log('Screen share ended');
                elements.screenVideo.srcObject = null;
                elements.screenVideo.classList.remove('active');
                elements.placeholder.style.display = 'block';
                state.activeScreenCall = null;
                showToast('üì∫ Screen share berakhir');
            });

        } else {
            // Handle face call
            state.activeFaceCall = call;
            
            if (!state.myCamStream) {
                // Request camera first
                requestCameraAndMic()
                    .then(stream => {
                        call.answer(stream);
                        setupCallHandlers(call);
                    })
                    .catch(() => {
                        call.answer(); // Answer without video
                        setupCallHandlers(call);
                    });
            } else {
                call.answer(state.myCamStream);
                setupCallHandlers(call);
            }
        }
    }

    function setupCallHandlers(call) {
        call.on('stream', (remoteStream) => {
            console.log('Receiving partner stream');
            elements.partnerCamVideo.srcObject = remoteStream;
            elements.partnerCamBox.classList.remove('offline');
            
            // Force play on mobile
            elements.partnerCamVideo.play().catch(e => {
                console.log('Autoplay prevented, trying with user gesture');
            });
            
            if (!state.isConnected) {
                updateUIConnected();
            }
        });

        call.on('close', () => {
            console.log('Partner disconnected');
            handleRemoteHangup();
        });

        call.on('error', (err) => {
            console.error('Call error:', err);
            showToast('‚ùå Koneksi terputus: ' + err.message);
        });
    }

    // ============================================
    // DATA CONNECTION
    // ============================================
    
    function handleIncomingData(conn) {
        state.dataConnection = conn;
        
        conn.on('data', (data) => {
            console.log('Received data:', data);
            if (data.type === 'status') {
                showToast('üí¨ ' + data.message);
            }
        });

        conn.on('close', () => {
            state.dataConnection = null;
        });
    }

    function sendData(data) {
        if (state.dataConnection && state.dataConnection.open) {
            state.dataConnection.send(data);
        }
    }

    // ============================================
    // CONNECT BUTTON HANDLER
    // ============================================
    
    async function handleConnectButton() {
        if (state.isConnecting) return;
        
        partnerId = elements.partnerIdInput.value.trim();
        
        if (!partnerId) {
            showToast('‚ö†Ô∏è Mohon isi ID Pasangan');
            elements.partnerIdInput.focus();
            return;
        }

        if (partnerId === myId) {
            showToast('‚ö†Ô∏è Tidak bisa menghubungi diri sendiri');
            return;
        }

        state.isConnecting = true;
        elements.connectBtnText.innerHTML = '<span class="spinner"></span> Menghubungi...';
        updateStatus('connecting', 'Menghubungi...');

        try {
            // Request camera and mic
            const stream = await requestCameraAndMic();
            
            // Create face call
            const call = peer.call(partnerId, stream, { 
                metadata: { type: 'face' } 
            });
            
            state.activeFaceCall = call;
            
            call.on('stream', (remoteStream) => {
                console.log('Connected! Receiving partner stream');
                elements.partnerCamVideo.srcObject = remoteStream;
                elements.partnerCamBox.classList.remove('offline');
                elements.partnerCamVideo.play().catch(e => console.log('Autoplay handled'));
                updateUIConnected();
            });

            call.on('close', handleRemoteHangup);
            
            call.on('error', (err) => {
                console.error('Call error:', err);
                showToast('‚ùå Gagal menghubungi: ' + err.message);
                state.isConnecting = false;
                elements.connectBtnText.innerHTML = 'Hubungkan Sekarang';
                updateStatus('error', 'Gagal');
            });

            // Create data connection
            state.dataConnection = peer.connect(partnerId);
            state.dataConnection.on('open', () => {
                console.log('Data connection established');
                sendData({ type: 'status', message: 'Terhubung dengan pasangan' });
            });

        } catch (err) {
            console.error('Connection error:', err);
            
            if (confirm('Gagal mengakses kamera/mic. Lanjut koneksi suara saja?')) {
                try {
                    const call = peer.call(partnerId, null, { 
                        metadata: { type: 'face' } 
                    });
                    
                    state.activeFaceCall = call;
                    
                    call.on('stream', (remoteStream) => {
                        elements.partnerCamVideo.srcObject = remoteStream;
                        elements.partnerCamBox.classList.remove('offline');
                        updateUIConnected();
                    });

                    call.on('close', handleRemoteHangup);
                    
                } catch (err2) {
                    showToast('‚ùå Koneksi gagal total');
                    state.isConnecting = false;
                    elements.connectBtnText.innerHTML = 'Hubungkan Sekarang';
                }
            } else {
                state.isConnecting = false;
                elements.connectBtnText.innerHTML = 'Hubungkan Sekarang';
                updateStatus('standby', 'Standby');
            }
        }
    }

    // ============================================
    // CAMERA & MIC MANAGEMENT
    // ============================================
    
    async function requestCameraAndMic() {
        try {
            const isMobile = window.innerWidth <= 768;
            const constraints = {
                video: {
                    facingMode: 'user',
                    width: { ideal: isMobile ? 640 : 1280 },
                    height: { ideal: isMobile ? 480 : 720 }
                },
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            };

            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            
            state.myCamStream = stream;
            elements.myCamVideo.srcObject = stream;
            elements.myCamVideo.muted = true;
            elements.myCamBox.classList.remove('offline');
            
            // Update state
            state.isCamOn = true;
            state.isMicOn = true;
            updateCamMicButtons();
            
            showToast('‚úÖ Kamera & Mic aktif');
            return stream;
            
        } catch (err) {
            console.error('getUserMedia error:', err);
            showToast('‚ö†Ô∏è Tidak dapat mengakses kamera/mic');
            throw err;
        }
    }

    function toggleMic() {
        if (!state.myCamStream) {
            showToast('‚ö†Ô∏è Belum terhubung');
            return;
        }

        const audioTrack = state.myCamStream.getAudioTracks()[0];
        if (audioTrack) {
            audioTrack.enabled = !audioTrack.enabled;
            state.isMicOn = audioTrack.enabled;
            updateCamMicButtons();
            showToast(state.isMicOn ? 'üé§ Mic ON' : 'üîá Mic OFF');
            
            sendData({ 
                type: 'status', 
                message: state.isMicOn ? 'Mic dinyalakan' : 'Mic dimatikan' 
            });
        }
    }

    function toggleCam() {
        if (!state.myCamStream) {
            showToast('‚ö†Ô∏è Belum terhubung');
            return;
        }

        const videoTrack = state.myCamStream.getVideoTracks()[0];
        if (videoTrack) {
            videoTrack.enabled = !videoTrack.enabled;
            state.isCamOn = videoTrack.enabled;
            updateCamMicButtons();
            showToast(state.isCamOn ? 'üìπ Camera ON' : 'üì∑ Camera OFF');
            
            sendData({ 
                type: 'status', 
                message: state.isCamOn ? 'Camera dinyalakan' : 'Camera dimatikan' 
            });
        }
    }

    function updateCamMicButtons() {
        updateBtnIcon('btnMic', state.isMicOn, 'fa-microphone', 'fa-microphone-slash');
        updateBtnIcon('btnCam', state.isCamOn, 'fa-video', 'fa-video-slash');
    }

    // ============================================
    // SCREEN SHARE
    // ============================================
    
    async function startScreenShare() {
        if (!partnerId && !state.isConnected) {
            showToast('‚ö†Ô∏è Hubungkan dengan pasangan terlebih dahulu');
            return;
        }

        if (!partnerId) {
            partnerId = elements.partnerIdInput.value.trim();
            if (!partnerId) {
                showToast('‚ö†Ô∏è Masukkan ID pasangan terlebih dahulu');
                return;
            }
        }

        // Check if on mobile
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
            if (!confirm('Screen share lebih baik dari PC/Laptop. Lanjutkan?')) {
                return;
            }
        }

        try {
            const stream = await navigator.mediaDevices.getDisplayMedia({
                video: {
                    cursor: 'always',
                    displaySurface: 'monitor'
                },
                audio: true
            });

            // Show on my screen too
            elements.screenVideo.srcObject = stream;
            elements.screenVideo.classList.add('active');
            elements.screenVideo.muted = true;
            elements.placeholder.style.display = 'none';
            state.isScreenSharing = true;

            // Call partner with screen stream
            const call = peer.call(partnerId, stream, { 
                metadata: { type: 'screen' } 
            });
            
            state.activeScreenCall = call;

            showToast('üì∫ Berbagi layar dimulai');
            sendData({ type: 'status', message: 'Mulai berbagi layar' });

            // Handle stop sharing (browser stop button)
            stream.getVideoTracks()[0].onended = () => {
                stopScreenShare();
            };

            call.on('close', () => {
                stopScreenShare();
            });

        } catch (err) {
            console.error('Screen share error:', err);
            if (err.name === 'NotAllowedError') {
                showToast('‚ùå Screen share dibatalkan');
            } else {
                showToast('‚ùå Gagal berbagi layar: ' + err.message);
            }
        }
    }

    function stopScreenShare() {
        if (elements.screenVideo.srcObject) {
            elements.screenVideo.srcObject.getTracks().forEach(track => track.stop());
            elements.screenVideo.srcObject = null;
            elements.screenVideo.classList.remove('active');
            elements.placeholder.style.display = 'block';
        }

        if (state.activeScreenCall) {
            state.activeScreenCall.close();
            state.activeScreenCall = null;
        }

        state.isScreenSharing = false;
        showToast('üì∫ Screen share dihentikan');
        sendData({ type: 'status', message: 'Berhenti berbagi layar' });
    }

    // ============================================
    // END CALL / HANGUP
    // ============================================
    
    function endCall() {
        if (!state.isConnected && !state.myCamStream && !state.activeScreenCall) {
            showToast('‚ö†Ô∏è Tidak ada koneksi aktif');
            return;
        }

        if (!confirm('Yakin ingin memutuskan koneksi?')) {
            return;
        }

        // Close all calls
        if (state.activeFaceCall) {
            state.activeFaceCall.close();
            state.activeFaceCall = null;
        }

        if (state.activeScreenCall) {
            state.activeScreenCall.close();
            state.activeScreenCall = null;
        }

        // Close data connection
        if (state.dataConnection) {
            sendData({ type: 'status', message: 'Memutuskan koneksi' });
            state.dataConnection.close();
            state.dataConnection = null;
        }

        // Stop all local streams
        if (state.myCamStream) {
            state.myCamStream.getTracks().forEach(track => track.stop());
            state.myCamStream = null;
        }

        if (elements.screenVideo.srcObject) {
            elements.screenVideo.srcObject.getTracks().forEach(track => track.stop());
            elements.screenVideo.srcObject = null;
        }

        // Reset video elements
        elements.myCamVideo.srcObject = null;
        elements.partnerCamVideo.srcObject = null;
        elements.screenVideo.classList.remove('active');
        elements.placeholder.style.display = 'block';

        // Reset cam boxes
        elements.myCamBox.classList.add('offline');
        elements.partnerCamBox.classList.add('offline');

        // Reset UI
        state.isConnected = false;
        state.isConnecting = false;
        state.isCamOn = false;
        state.isMicOn = false;
        state.isScreenSharing = false;
        partnerId = null;

        elements.connectPanel.classList.remove('hidden');
        elements.partnerIdInput.value = '';
        elements.connectBtnText.innerHTML = 'Hubungkan Sekarang';
        
        updateStatus('standby', 'Terputus');
        updateCamMicButtons();
        
        showToast('üìû Koneksi diputus');

        // After 2 seconds, change status back to standby
        setTimeout(() => {
            if (!state.isConnected) {
                updateStatus('standby', 'Standby');
            }
        }, 2000);
    }

    function handleRemoteHangup() {
        showToast('üìû Pasangan memutuskan koneksi');
        
        // Keep screen share running if active
        const wasScreenSharing = state.isScreenSharing;
        
        endCall();
        
        // If was screen sharing, offer to continue
        if (wasScreenSharing) {
            setTimeout(() => {
                if (confirm('Screen share masih aktif. Lanjutkan berbagi?')) {
                    // Screen share will continue
                } else {
                    stopScreenShare();
                }
            }, 1000);
        }
    }

    // ============================================
    // UI HELPERS
    // ============================================
    
    function updateUIConnected() {
        state.isConnected = true;
        state.isConnecting = false;
        
        elements.connectPanel.classList.add('hidden');
        updateStatus('connected', 'Terhubung ‚ù§Ô∏è');
        elements.connectBtnText.innerHTML = 'Hubungkan Sekarang';
        
        showToast('‚úÖ Berhasil terhubung dengan pasangan!');
    }

    function updateStatus(type, text) {
        const badge = elements.statusBadge;
        badge.className = type;
        badge.innerHTML = `<span class="status-dot"></span><span>${text}</span>`;
    }

    function updateBtnIcon(id, isActive, onIcon, offIcon) {
        const btn = document.getElementById(id);
        const icon = btn.querySelector('i');
        
        if (isActive) {
            btn.classList.add('active');
            icon.className = `fas ${onIcon}`;
        } else {
            btn.classList.remove('active');
            icon.className = `fas ${offIcon}`;
        }
    }

    function showToast(message) {
        const toast = elements.toast;
        toast.textContent = message;
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    function copyMyId() {
        const id = elements.myIdEl.innerText;
        
        if (id === 'Generating...') {
            showToast('‚è≥ ID masih dibuat, tunggu sebentar');
            return;
        }

        navigator.clipboard.writeText(id)
            .then(() => {
                showToast('‚úÖ ID disalin! Kirim ke pasangan');
            })
            .catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = id;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('‚úÖ ID disalin! Kirim ke pasangan');
            });
    }

    // ============================================
    // FULLSCREEN SUPPORT
    // ============================================
    
    elements.screenVideo.addEventListener('dblclick', () => {
        const elem = elements.screenVideo;
        
        if (!document.fullscreenElement) {
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
            showToast('üñ•Ô∏è Mode fullscreen');
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
            showToast('üñ•Ô∏è Keluar fullscreen');
        }
    });

    // ============================================
    // MOBILE OPTIMIZATION
    // ============================================
    
    // Prevent iOS Safari bounce effect
    document.body.addEventListener('touchmove', (e) => {
        if (e.target === elements.screenVideo) {
            // Allow scrolling on video
        } else {
            e.preventDefault();
        }
    }, { passive: false });

    // Handle orientation change
    window.addEventListener('orientationchange', () => {
        setTimeout(() => {
            showToast('üì± Orientasi berubah');
        }, 100);
    });

    // ============================================
    // KEYBOARD SHORTCUTS
    // ============================================
    
    document.addEventListener('keydown', (e) => {
        // M for mic
        if (e.key === 'm' || e.key === 'M') {
            e.preventDefault();
            toggleMic();
        }
        
        // V for video
        if (e.key === 'v' || e.key === 'V') {
            e.preventDefault();
            toggleCam();
        }
        
        // S for screen share
        if (e.key === 's' || e.key === 'S') {
            e.preventDefault();
            startScreenShare();
        }
        
        // Escape to end call
        if (e.key === 'Escape') {
            if (state.isConnected) {
                endCall();
            }
        }
        
        // F for fullscreen
        if (e.key === 'f' || e.key === 'F') {
            if (elements.screenVideo.srcObject) {
                elements.screenVideo.dispatchEvent(new Event('dblclick'));
            }
        }
    });

    // ============================================
    // VISIBILITY CHANGE HANDLER
    // ============================================
    
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            console.log('App hidden');
        } else {
            console.log('App visible again');
            // Recheck connections
            if (state.isConnected) {
                showToast('üëã Kembali ke aplikasi');
            }
        }
    });

    // ============================================
    // BEFORE UNLOAD WARNING
    // ============================================
    
    window.addEventListener('beforeunload', (e) => {
        if (state.isConnected || state.myCamStream) {
            e.preventDefault();
            e.returnValue = 'Anda masih terhubung. Yakin ingin keluar?';
            return e.returnValue;
        }
    });

    // ============================================
    // INITIALIZE ON LOAD
    // ============================================
    
    window.addEventListener('load', () => {
        initializePeer();
        console.log('Private Cinema initialized');
        
        // Check if on mobile
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
            console.log('Mobile device detected');
        } else {
            console.log('Desktop device detected');
        }
    });

    // ============================================
    // ERROR RECOVERY
    // ============================================
    
    window.addEventListener('error', (e) => {
        console.error('Global error:', e.error);
        showToast('‚ùå Terjadi kesalahan: ' + e.message);
    });

    window.addEventListener('unhandledrejection', (e) => {
        console.error('Unhandled promise rejection:', e.reason);
        showToast('‚ùå Error: ' + e.reason);
    });

</script>
</body>
</html>