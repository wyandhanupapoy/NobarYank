<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wyandhanu & Maha - Private Cinema</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --primary: #f43f5e;
            --accent: #3b82f6;
            --glass: rgba(15, 23, 42, 0.85);
            --text: #f8fafc;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text);
            margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }
        header {
            padding: 15px 20px; background: rgba(0,0,0,0.3); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; z-index: 50;
        }
        .couple-names { font-size: 1rem; font-weight: 600; }
        .couple-names span { color: var(--primary); }
        .heart-icon { color: var(--primary); margin: 0 5px; animation: heartbeat 1.5s infinite; }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        
        .main-stage { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; background: black; }
        #screenVideo { width: 100%; height: 100%; max-height: 80vh; object-fit: contain; }
        .placeholder-text { position: absolute; color: #64748b; text-align: center; z-index: 0; }
        
        .cam-container {
            position: absolute; bottom: 100px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 20;
        }
        .cam-box {
            width: 120px; height: 120px; background: #333; border-radius: 12px; overflow: hidden;
            border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 4px 15px rgba(0,0,0,0.5); position: relative;
        }
        .cam-box video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .cam-label { position: absolute; bottom: 0; left: 0; width: 100%; font-size: 10px; background: rgba(0,0,0,0.6); text-align: center; padding: 2px; }

        .control-bar {
            padding: 15px; background: var(--glass); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: center; gap: 15px; z-index: 50;
        }
        .btn-control {
            width: 50px; height: 50px; border-radius: 50%; border: none; background: #334155; color: white;
            font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .btn-control:hover { transform: scale(1.1); }
        .btn-control.active { background: var(--primary); box-shadow: 0 0 15px var(--primary); }
        
        .connection-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(15, 23, 42, 0.95); padding: 30px; border-radius: 20px; border: 1px solid #334155;
            text-align: center; z-index: 100; width: 90%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }
        .connection-panel.hidden { display: none; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #475569; background: #1e293b; color: white; text-align: center; }
        .id-display { font-size: 0.9rem; color: #94a3b8; margin-top: 15px; cursor: pointer; padding: 5px; border: 1px dashed #475569; border-radius: 6px; }

        @media (max-width: 768px) {
            .cam-container { flex-direction: row; bottom: 90px; right: 10px; left: 10px; justify-content: center; }
            .cam-box { width: 80px; height: 80px; border-radius: 50%; }
        }
        @media (max-height: 500px) and (orientation: landscape) {
            header, .control-bar { opacity: 0; transition: opacity 0.5s; }
            header:hover, .control-bar:hover { opacity: 1; }
            .cam-container { right: 10px; bottom: 10px; flex-direction: column; }
            .cam-box { width: 100px; height: 100px; opacity: 0.8; }
        }
    </style>
</head>
<body>

<header>
    <div class="couple-names">Wyandhanu <i class="fas fa-heart heart-icon"></i> Maha</div>
    <div id="statusBadge" style="font-size:0.8rem; color:#94a3b8;">Offline</div>
</header>

<div class="main-stage">
    <div class="placeholder-text"><i class="fas fa-film" style="font-size: 3rem; margin-bottom:10px;"></i><br>Layar Film Akan Muncul Di Sini</div>
    <video id="screenVideo" autoplay playsinline></video>
    <div class="cam-container">
        <div class="cam-box"><video id="myCam" autoplay playsinline muted></video><div class="cam-label">Saya</div></div>
        <div class="cam-box"><video id="partnerCam" autoplay playsinline></video><div class="cam-label">Pasangan</div></div>
    </div>
</div>

<div id="connectPanel" class="connection-panel">
    <h3>Mulai Nobar üçø</h3>
    <input type="text" id="partnerIdInput" placeholder="Tempel ID Pasangan di sini...">
    <button onclick="handleConnectButton()" class="btn-control active" style="width:100%; border-radius:8px; height:45px; font-size:1rem; margin-top:10px;">Hubungkan</button>
    <div class="id-display" onclick="copyMyId()">ID Kamu: <span id="myId" style="color:var(--accent); font-weight:bold;">Generating...</span></div>
</div>

<div class="control-bar">
    <button id="btnMic" onclick="toggleMic()" class="btn-control"><i class="fas fa-microphone-slash"></i></button>
    <button id="btnCam" onclick="toggleCam()" class="btn-control"><i class="fas fa-video-slash"></i></button>
    <button onclick="startScreenShare()" class="btn-control active" style="background-color: var(--accent);"><i class="fas fa-desktop"></i></button>
</div>

<script>
    const peer = new Peer(undefined, { debug: 1, config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] } });
    const myIdEl = document.getElementById('myId');
    const connectPanel = document.getElementById('connectPanel');
    const statusBadge = document.getElementById('statusBadge');
    const screenVideo = document.getElementById('screenVideo');
    const myCamVideo = document.getElementById('myCam');
    const partnerCamVideo = document.getElementById('partnerCam');

    let myCamStream = null;
    let isMicOn = false;
    let isCamOn = false;

    peer.on('open', (id) => {
        myIdEl.innerText = id;
        statusBadge.innerText = "Menunggu Pasangan...";
    });

    peer.on('call', (call) => {
        const callType = call.metadata ? call.metadata.type : 'face'; 
        if (callType === 'screen') {
            call.answer(); 
            call.on('stream', (stream) => {
                screenVideo.srcObject = stream;
                statusBadge.innerText = "Sedang Menonton Film";
                statusBadge.style.color = "#4ade80";
                connectPanel.classList.add('hidden');
            });
        } else {
            // Jika ada panggilan masuk, coba nyalakan kamera kita
            requestCameraAndMic()
                .then(stream => {
                    call.answer(stream);
                })
                .catch(() => {
                    // Jika gagal (device in use), jawab tanpa stream (audio only atau cuma nonton)
                    call.answer(); 
                    alert("Kamera/Mic Anda sibuk/terblokir. Anda tetap bisa menonton film, tapi pasangan tidak bisa melihat/mendengar Anda.");
                });
            
            call.on('stream', (remoteStream) => {
                partnerCamVideo.srcObject = remoteStream;
                statusBadge.innerText = "Terhubung ‚ù§Ô∏è";
                connectPanel.classList.add('hidden');
            });
        }
    });

    // Wrapper untuk handle Connect Button
    function handleConnectButton() {
        const partnerId = document.getElementById('partnerIdInput').value.trim();
        if(!partnerId) return alert("Masukkan ID dulu!");
        
        statusBadge.innerText = "Menghubungi...";
        
        // Coba akses kamera dulu sebelum nelpon
        requestCameraAndMic()
            .then(stream => {
                // Sukses akses kamera, mulai call dengan stream
                const call = peer.call(partnerId, stream, { metadata: { type: 'face' } });
                handleCallStream(call);
            })
            .catch(err => {
                // Gagal akses kamera (Device in use), tawarkan opsi
                const proceed = confirm("Gagal akses kamera (Device in use/Error). Lanjut tanpa kamera/mic?");
                if(proceed) {
                    // Call tanpa stream (Null)
                    const call = peer.call(partnerId, null, { metadata: { type: 'face' } });
                    handleCallStream(call);
                } else {
                    statusBadge.innerText = "Koneksi dibatalkan.";
                }
            });
    }

    function handleCallStream(call) {
        call.on('stream', (remoteStream) => {
            partnerCamVideo.srcObject = remoteStream;
            statusBadge.innerText = "Terhubung ‚ù§Ô∏è";
            statusBadge.style.color = "#4ade80";
            connectPanel.classList.add('hidden');
        });
        call.on('close', () => alert("Panggilan berakhir"));
    }

    // Fungsi Request Camera yang Aman (Try Catch)
    async function requestCameraAndMic() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            myCamStream = stream;
            myCamVideo.srcObject = stream;
            updateCamMicState(true, true);
            return stream;
        } catch (err) {
            console.error("Camera Error:", err);
            
            // Jika gagal video+audio, coba audio saja (siapa tau cuma kamera yg rusak)
            try {
                const audioStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
                myCamStream = audioStream;
                updateCamMicState(false, true);
                alert("Kamera gagal/sibuk, beralih ke Mode Suara saja.");
                return audioStream;
            } catch (err2) {
                // Gagal total
                throw new Error("Device in use");
            }
        }
    }

    async function startScreenShare() {
        const partnerId = document.getElementById('partnerIdInput').value.trim();
        if (!partnerId) return alert("Belum ada ID pasangan. Hubungkan dulu.");
        try {
            const stream = await navigator.mediaDevices.getDisplayMedia({
                video: { cursor: "always", width: { ideal: 1920 } },
                audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } 
            });
            screenVideo.srcObject = stream;
            screenVideo.muted = true; 
            const call = peer.call(partnerId, stream, { metadata: { type: 'screen' } });
            stream.getVideoTracks()[0].onended = () => { call.close(); screenVideo.srcObject = null; };
        } catch (err) { console.error(err); }
    }

    function toggleMic() {
        if (!myCamStream) return;
        const audioTrack = myCamStream.getAudioTracks()[0];
        if (audioTrack) {
            audioTrack.enabled = !audioTrack.enabled;
            isMicOn = audioTrack.enabled;
            updateBtnIcon('btnMic', isMicOn, 'fa-microphone', 'fa-microphone-slash');
        }
    }

    function toggleCam() {
        if (!myCamStream) return;
        const videoTrack = myCamStream.getVideoTracks()[0];
        if (videoTrack) {
            videoTrack.enabled = !videoTrack.enabled;
            isCamOn = videoTrack.enabled;
            updateBtnIcon('btnCam', isCamOn, 'fa-video', 'fa-video-slash');
        }
    }

    function updateCamMicState(cam, mic) {
        isCamOn = cam; isMicOn = mic;
        updateBtnIcon('btnCam', isCamOn, 'fa-video', 'fa-video-slash');
        updateBtnIcon('btnMic', isMicOn, 'fa-microphone', 'fa-microphone-slash');
    }

    function updateBtnIcon(btnId, isActive, iconOn, iconOff) {
        const btn = document.getElementById(btnId);
        const icon = btn.querySelector('i');
        if (isActive) { btn.classList.add('active'); icon.classList.remove(iconOff); icon.classList.add(iconOn); } 
        else { btn.classList.remove('active'); icon.classList.remove(iconOn); icon.classList.add(iconOff); }
    }

    function copyMyId() { navigator.clipboard.writeText(myIdEl.innerText); alert("ID Disalin!"); }
    
    screenVideo.addEventListener('dblclick', () => { if(screenVideo.requestFullscreen) screenVideo.requestFullscreen(); });
</script>
</body>
</html>