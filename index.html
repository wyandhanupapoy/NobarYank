<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wyandhanu & Maha - Private Cinema</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --primary: #f43f5e;
            --accent: #3b82f6;
            --danger: #ef4444;
            --glass: rgba(15, 23, 42, 0.9);
            --text: #f8fafc;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER */
        header {
            padding: 15px 20px;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 50;
        }

        .couple-names { font-size: 1rem; font-weight: 600; }
        .couple-names span { color: var(--primary); }
        .heart-icon { color: var(--primary); margin: 0 5px; animation: heartbeat 1.5s infinite; }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

        /* AREA UTAMA */
        .main-stage {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background: black;
            width: 100%;
        }

        #screenVideo {
            width: 100%;
            height: 100%;
            max-height: 85vh;
            object-fit: contain; /* Agar film tidak gepeng di HP */
        }

        .placeholder-text {
            position: absolute;
            color: #64748b;
            text-align: center;
            z-index: 0;
            padding: 20px;
        }

        /* KAMERA FLOATING (Pip) */
        .cam-container {
            position: absolute;
            bottom: 100px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 20;
            transition: all 0.3s ease;
        }

        .cam-box {
            width: 120px;
            height: 120px;
            background: #1e293b;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            position: relative;
        }

        .cam-box video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror effect */
        }
        
        .cam-label {
            position: absolute; bottom: 0; left: 0; width: 100%;
            font-size: 10px; background: rgba(0,0,0,0.6); text-align: center; padding: 2px;
        }

        /* PANEL KONEKSI */
        .connection-panel {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid #334155;
            text-align: center;
            z-index: 100;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            transition: opacity 0.3s;
        }
        
        .connection-panel.hidden {
            opacity: 0;
            pointer-events: none;
            display: none; /* Penting agar tidak menghalangi klik video */
        }

        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #475569;
            background: #1e293b;
            color: white;
            text-align: center;
            font-size: 16px; /* Mencegah zoom in otomatis di iPhone */
        }

        /* CONTROL BAR */
        .control-bar {
            padding: 15px;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom); /* Support iPhone X+ */
        }

        .btn-control {
            width: 50px; height: 50px;
            border-radius: 50%;
            border: none;
            background: #334155;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-control:hover { transform: scale(1.1); }
        .btn-control.active { background: var(--primary); box-shadow: 0 0 15px var(--primary); }
        
        /* Tombol End Call Khusus */
        .btn-hangup {
            background-color: var(--danger) !important;
        }
        .btn-hangup:hover { background-color: #dc2626 !important; }

        /* RESPONSIVE HP */
        @media (max-width: 768px) {
            .cam-container {
                flex-direction: row; /* Kamera jejer ke samping di HP */
                bottom: 85px; 
                right: 50%; 
                transform: translateX(50%);
                width: 100%;
                justify-content: center;
            }
            .cam-box { width: 80px; height: 80px; border-radius: 50%; } /* Jadi bulat di HP */
        }

        /* HP MODE LANDSCAPE (FULLSCREEN FILM) */
        @media (max-height: 500px) and (orientation: landscape) {
            header, .control-bar { opacity: 0; pointer-events: none; transition: 0.5s; }
            /* Munculkan tombol kalau disentuh layar atas/bawah */
            header:hover, .control-bar:hover { opacity: 1; pointer-events: auto; }
            
            .cam-container {
                right: 10px; bottom: 10px; 
                flex-direction: column; 
                transform: none;
                width: auto;
            }
            .cam-box { width: 90px; height: 90px; opacity: 0.6; }
            .cam-box:hover { opacity: 1; }
        }
    </style>
</head>
<body>

<header>
    <div class="couple-names">Wyandhanu <i class="fas fa-heart heart-icon"></i> Maha</div>
    <div id="statusBadge" style="font-size:0.7rem; color:#94a3b8; background:#1e293b; padding:4px 8px; border-radius:10px;">Offline</div>
</header>

<div class="main-stage">
    <div class="placeholder-text">
        <i class="fas fa-film" style="font-size: 3rem; margin-bottom:10px;"></i><br>
        Menunggu Koneksi...
    </div>
    
    <video id="screenVideo" autoplay playsinline></video>

    <div class="cam-container">
        <div class="cam-box">
            <video id="myCam" autoplay playsinline muted></video>
            <div class="cam-label">Saya</div>
        </div>
        <div class="cam-box">
            <video id="partnerCam" autoplay playsinline></video>
            <div class="cam-label">Pasangan</div>
        </div>
    </div>
</div>

<div id="connectPanel" class="connection-panel">
    <h3 style="margin-top:0;">Mulai Nobar üçø</h3>
    <input type="text" id="partnerIdInput" placeholder="Tempel ID Pasangan disini...">
    
    <button onclick="handleConnectButton()" class="btn-control active" style="width:100%; border-radius:8px; height:45px; font-size:1rem; margin-top:10px;">
        Hubungkan Sekarang
    </button>
    
    <div class="id-display" onclick="copyMyId()" style="margin-top:15px; padding:10px; border:1px dashed #475569; border-radius:8px; cursor:pointer;">
        <div style="font-size:0.8rem; color:#94a3b8;">ID Kamu (Klik Salin):</div>
        <div id="myId" style="color:var(--accent); font-weight:bold; word-break:break-all;">Generating...</div>
    </div>
</div>

<div class="control-bar">
    <button id="btnMic" onclick="toggleMic()" class="btn-control"><i class="fas fa-microphone-slash"></i></button>
    
    <button onclick="endCall()" class="btn-control btn-hangup" title="Putuskan Jaringan">
        <i class="fas fa-phone-slash"></i>
    </button>

    <button id="btnCam" onclick="toggleCam()" class="btn-control"><i class="fas fa-video-slash"></i></button>
    
    <button onclick="startScreenShare()" class="btn-control active" style="background-color: var(--accent); margin-left:10px;" title="Share Screen">
        <i class="fas fa-desktop"></i>
    </button>
</div>

<script>
    // --- KONFIGURASI CROSS-PLATFORM ---
    // Menggunakan banyak STUN server agar HP (4G) bisa tembus ke WiFi
    const peerConfig = {
        debug: 1,
        config: {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:global.stun.twilio.com:3478' } 
            ]
        }
    };

    const peer = new Peer(undefined, peerConfig);
    
    // UI Elements
    const myIdEl = document.getElementById('myId');
    const connectPanel = document.getElementById('connectPanel');
    const statusBadge = document.getElementById('statusBadge');
    
    // Video Elements
    const screenVideo = document.getElementById('screenVideo');
    const myCamVideo = document.getElementById('myCam');
    const partnerCamVideo = document.getElementById('partnerCam');

    // State Variables
    let myCamStream = null;
    let activeCall = null;      // Menyimpan objek Call aktif
    let activeConn = null;      // Menyimpan koneksi data (opsional)
    let isMicOn = false;
    let isCamOn = false;

    // 1. SAAT PEER SIAP (DAPAT ID)
    peer.on('open', (id) => {
        myIdEl.innerText = id;
        statusBadge.innerText = "Standby (Bagikan ID)";
        statusBadge.style.color = "#94a3b8";
    });

    // 2. SAAT MENERIMA TELEPON (DARI HP/LAPTOP PASANGAN)
    peer.on('call', (call) => {
        // Jika sedang ada call lain, tolak atau tutup yg lama (opsional)
        // Disini kita terima saja.
        
        const callType = call.metadata ? call.metadata.type : 'face';

        if (callType === 'screen') {
            // TERIMA SHARE SCREEN
            call.answer();
            call.on('stream', (stream) => {
                screenVideo.srcObject = stream;
                statusBadge.innerText = "Menonton Film";
                statusBadge.style.color = "#4ade80"; // Hijau
                connectPanel.classList.add('hidden');
            });
            call.on('close', () => {
                screenVideo.srcObject = null;
            });
        } else {
            // TERIMA VIDEO CALL (WAJAH)
            activeCall = call; // Simpan referensi call untuk tombol 'Putus'
            
            // Coba nyalakan kamera kita untuk menjawab
            requestCameraAndMic()
                .then(stream => {
                    call.answer(stream); // Jawab dengan video kita
                    updateUIConnected();
                })
                .catch(() => {
                    call.answer(); // Jawab tanpa video jika error
                    updateUIConnected();
                });
            
            call.on('stream', (remoteStream) => {
                partnerCamVideo.srcObject = remoteStream;
                // Hack untuk Mobile Browser: kadang video butuh trigger play
                partnerCamVideo.play().catch(e => console.log("Autoplay handled"));
            });

            call.on('close', () => handleRemoteHangup());
        }
    });

    // --- FUNGSI UTAMA ---

    function handleConnectButton() {
        const partnerId = document.getElementById('partnerIdInput').value.trim();
        if(!partnerId) return alert("Mohon isi ID Pasangan.");

        statusBadge.innerText = "Menghubungi...";
        
        // Nyalakan kamera dulu
        requestCameraAndMic()
            .then(stream => {
                // Mulai Panggilan Video
                const call = peer.call(partnerId, stream, { metadata: { type: 'face' } });
                activeCall = call;
                
                call.on('stream', (remoteStream) => {
                    partnerCamVideo.srcObject = remoteStream;
                    partnerCamVideo.play().catch(e => console.log("Autoplay handled"));
                    updateUIConnected();
                });
                
                call.on('close', () => handleRemoteHangup());
                call.on('error', (e) => alert("Koneksi gagal: " + e));
            })
            .catch(err => {
                // Jika kamera gagal, tanya user mau lanjut audio only?
                if(confirm("Gagal akses kamera. Lanjut koneksi suara saja?")) {
                     const call = peer.call(partnerId, null, { metadata: { type: 'face' } });
                     activeCall = call;
                     call.on('stream', (remoteStream) => {
                        partnerCamVideo.srcObject = remoteStream;
                        updateUIConnected();
                     });
                } else {
                    statusBadge.innerText = "Batal.";
                }
            });
    }

    // FUNGSI SHARE SCREEN (KHUSUS LAPTOP/PC)
    async function startScreenShare() {
        const partnerId = document.getElementById('partnerIdInput').value.trim();
        // Cek apakah user pakai HP? (HP tidak bisa share screen biasanya)
        if(window.innerWidth < 768) {
            alert("Fitur Share Screen sebaiknya dilakukan dari Laptop/PC Host.");
            // Tapi tetap kita izinkan coba
        }

        if (!partnerId && !activeCall) return alert("Sambungkan hubungan wajah dulu baru share screen.");
        
        // Jika partnerId kosong tapi activeCall ada, ambil ID dari activeCall (agak tricky di PeerJS)
        // Jadi kita paksa user isi input ID agar aman.
        if (!partnerId) return alert("Pastikan ID Pasangan tertulis di kotak input.");

        try {
            const stream = await navigator.mediaDevices.getDisplayMedia({
                video: { cursor: "always" },
                audio: { echoCancellation: false, noiseSuppression: false } // Audio film murni
            });

            screenVideo.srcObject = stream;
            screenVideo.muted = true; // Host mute lokal

            const call = peer.call(partnerId, stream, { metadata: { type: 'screen' } });
            
            // Tombol Stop Bawaan Browser
            stream.getVideoTracks()[0].onended = () => {
                call.close();
                screenVideo.srcObject = null;
            };

        } catch (err) {
            console.error(err);
        }
    }

    // --- FITUR PUTUSKAN JARINGAN (HANGUP) ---
    function endCall() {
        if (!activeCall && !screenVideo.srcObject && !myCamStream) {
            return alert("Tidak ada koneksi aktif.");
        }

        // 1. Matikan Call PeerJS
        if (activeCall) {
            activeCall.close();
            activeCall = null;
        }

        // 2. Matikan Kamera & Mic Sendiri (Penting agar lampu webcam mati)
        if (myCamStream) {
            myCamStream.getTracks().forEach(track => track.stop());
            myCamStream = null;
        }

        // 3. Reset Video Elements
        myCamVideo.srcObject = null;
        partnerCamVideo.srcObject = null;
        screenVideo.srcObject = null;

        // 4. Reset UI
        connectPanel.classList.remove('hidden'); // Munculkan panel login lagi
        statusBadge.innerText = "Terputus";
        statusBadge.style.color = "#ef4444"; // Merah
        
        // Reset tombol icon
        updateCamMicState(false, false);
    }

    function handleRemoteHangup() {
        alert("Pasangan memutuskan hubungan.");
        endCall();
    }

    // --- HELPER KAMERA & MIC ---
    
    async function requestCameraAndMic() {
        try {
            // Constraint khusus Mobile: prefer kamera depan
            const constraints = { 
                video: { facingMode: "user", width: { ideal: 640 }, height: { ideal: 480 } }, // Ringan buat HP
                audio: true 
            };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            
            myCamStream = stream;
            myCamVideo.srcObject = stream;
            myCamVideo.muted = true; // Mute diri sendiri agar tidak feedback
            
            updateCamMicState(true, true);
            return stream;
        } catch (err) {
            throw err;
        }
    }

    function toggleMic() {
        if (!myCamStream) return;
        const track = myCamStream.getAudioTracks()[0];
        if(track) {
            track.enabled = !track.enabled;
            updateBtnIcon('btnMic', track.enabled, 'fa-microphone', 'fa-microphone-slash');
        }
    }

    function toggleCam() {
        if (!myCamStream) return;
        const track = myCamStream.getVideoTracks()[0];
        if(track) {
            track.enabled = !track.enabled;
            updateBtnIcon('btnCam', track.enabled, 'fa-video', 'fa-video-slash');
        }
    }

    // --- UI HELPERS ---
    
    function updateUIConnected() {
        statusBadge.innerText = "Terhubung ‚ù§Ô∏è";
        statusBadge.style.color = "#4ade80";
        connectPanel.classList.add('hidden'); // Sembunyikan panel ID
    }

    function updateCamMicState(cam, mic) {
        updateBtnIcon('btnCam', cam, 'fa-video', 'fa-video-slash');
        updateBtnIcon('btnMic', mic, 'fa-microphone', 'fa-microphone-slash');
    }

    function updateBtnIcon(id, isActive, onIcon, offIcon) {
        const btn = document.getElementById(id);
        const i = btn.querySelector('i');
        if (isActive) {
            btn.classList.add('active');
            i.className = `fas ${onIcon}`;
        } else {
            btn.classList.remove('active');
            i.className = `fas ${offIcon}`;
        }
    }

    function copyMyId() {
        navigator.clipboard.writeText(myIdEl.innerText);
        alert("ID berhasil disalin! Kirim ke HP/Laptop pasangan.");
    }
    
    // Double click untuk fullscreen film
    screenVideo.addEventListener('dblclick', () => {
        if(screenVideo.requestFullscreen) screenVideo.requestFullscreen();
        else if(screenVideo.webkitRequestFullscreen) screenVideo.webkitRequestFullscreen(); // Safari Support
    });

</script>
</body>
</html>